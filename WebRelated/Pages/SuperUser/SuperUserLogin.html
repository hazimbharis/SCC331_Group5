<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <script src="https://kit.fontawesome.com/e0b1d3493e.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../Stylesheets/Signup.css">
    <link rel="stylesheet" type="text/css" href="../../Stylesheets/SignNavBar.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otplib/otplib-browser.js"></script>
</head>
<body >
    <nav class="navbar">
        <div class="containerNav">
            <a href="SuperUserSignUp.html">1. Sign-up</a>
            <i class="fa-solid fa-arrow-right next-arrow"></i>
            <a href="MFASetup.html">2. MFA Setup</a>
            <i class="fa-solid fa-arrow-right next-arrow"></i>
            <a href="SuperUserLogin.html">3. Login</a>
        </div>
    </nav>
    <div class="form-container">
        <h2 id ="Sign-up">Sign in</h2>
        <form class="form-box" onsubmit="return false;">

      

            <label for="email">Email</label>
            <input type="text" id="email" name="email" required>
      
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
              
            <label for="MFAKey">MFA Token</label>
            <input type="password" id="MFAToken" name="MFAToken" required>
              
            <button type="button" onclick="processLogin()">Login</button>
            <span class ="error-box"></span>

            <div style="font-family: Roboto, Helvetica, sans-serif; font-weight: 100;" id= "Message-Container-Signin" class="Message-Container"></div>
        
           <!--
            <span class="psw">Forgot <a href="#">password?</a></span>            
           -->
        </form>
      </div>

</body>
<script>
    var messageBox = document.getElementById('Message-Container-Signin');
    async function processLogin(){
        if(true){
            var email = document.getElementById('email').value;
            var pword = document.getElementById('password').value;
            var token = document.getElementById('MFAToken').value;

            console.log("Email: " + email);
            console.log("Password: " + pword);
            console.log("Token: " + token);
            
            const credentialsValid = await checkcredentials(email, pword);
            if (!credentialsValid){return;}
            const returnInfo = await checkToken(email);
            if(!returnInfo.tokenValid){return;}
            const isValid = await verifyTOTP(returnInfo.theKey, token);
            if(isValid){

                messageBox.style.color = 'Green';
                messageBox.innerHTML = "Success!";

                //location.replace("../Home.html");
                const loadingIcon = document.createElement('div');
                loadingIcon.classList.add('loading-icon');

                // Add styles to the loading icon
                loadingIcon.style.border = '4px solid #f3f3f3'; /* Light grey */
                loadingIcon.style.borderTop = '4px solid #3498db'; /* Blue */
                loadingIcon.style.borderRadius = '50%';
                loadingIcon.style.width = '40px';
                loadingIcon.style.height = '40px';
                loadingIcon.style.animation = 'spin 1s linear infinite'; /* Spin animation */
                loadingIcon.style.justifySelf = 'center';
                loadingIcon.style.position = 'relative';
                loadingIcon.style.left = '42%';
                
                // Append the loading icon to the body
                messageBox.appendChild(loadingIcon);


                try {
                    const response = await $.get('http://localhost:5001/api/getOrganisationName/' + returnInfo.orgID);
                    const orgName = response[0]
                    console.log(orgName.OrganisationName)

                    if (orgName.OrganisationName.valueOf() == 'HotelSystem') {
                        const nextResponse = await $.get('http://localhost:5000/api/changeDatabase/hotel');
                        console.log(nextResponse);
                        const http = new XMLHttpRequest();
                        const url = 'http://localhost:8080/changeURL?url=hotel';
                        http.open("GET", url);
                        http.send();
                        setTimeout(function() {
                        window.location.href = "../../hotel/Pages/Home.html";}, 2000);
                    } else if (orgName.OrganisationName.valueOf() == 'PrisonSystem') {
                        const nextResponse = await $.get('http://localhost:5000/api/changeDatabase/microbits');
                        console.log(nextResponse);
                        const http = new XMLHttpRequest();
                        const url = 'http://localhost:8080/changeURL?url=microbits';
                        http.open("GET", url);
                        http.send();
                        setTimeout(function() {
                        window.location.href = "../PrisonHome.html";}, 2000);
                    }
                    } catch (error) {
                        console.error('Error getting secret key:', error);
                        messageBox.style.color = 'red';
                        messageBox.innerHTML = "Didn't get MFA key";
                        throw error; // Rethrow the error to handle it in the caller
                        return {tokenValid: false, theKey: null};
                    }
            }else{
                messageBox.style.color = 'Red';
                messageBox.innerHTML = "TOTP Incorrect";     
            }

        }
    }
    async function verifyTOTP(secretKey, totpCode) {
        const isValid = await otplib.authenticator.check(totpCode, secretKey);
        return isValid;
    }
    async function checkToken(email){
        try {
        const response = await $.get('http://localhost:5001/api/GetMFAKey/' + email);
        const secretKey = response[0].SecretKey;
        const orgID = response[0].OrganisationId
        if (secretKey === null){
            throw "Not found";
        }
        console.log("secretKey:", response);
        console.log("secretKey: " + secretKey);
        return {tokenValid: true, theKey: secretKey, orgID: orgID};
        
    } catch (error) {
        console.error('Error getting secret key:', error);
        messageBox.style.color = 'red';
        messageBox.innerHTML = "Didn't get MFA key";
        throw error; // Rethrow the error to handle it in the caller
        return {tokenValid: false, theKey: null};
    }
    }
    function checkcredentials(e, p){
        return new Promise((resolve, reject) => {
        fetch('http://localhost:5001/api/CheckCredentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                credentials: {
                    email: e,
                    password: p,
                }
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.message === "Login successful") {
                console.log(data); // Display the response data
                resolve(true);
            } else {
                messageBox.style.color = 'red';
                messageBox.innerHTML = "Login Failed";
                resolve(false);
            }
        })
        .catch(error => {
            messageBox.style.color = 'red';
            messageBox.innerHTML = "Login Failed";
            console.error('There was a problem with the fetch operation:', error);
            reject(error);
        });  
    });
    }
</script>
</html>